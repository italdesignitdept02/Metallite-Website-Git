{%- assign selected_variant = product.selected_or_first_available_variant -%}
{%- assign product_form_id = 'product_form_' | append: section.id | append: product.id -%}



<div class="card {% if product.media.size > 0 %}card--collapsed{% endif %} {% if template.name == 'product' %}card--sticky{% endif %}">
  {%- if section.settings.enable_image_zoom -%}
    <div id="product-zoom-{{ section.id }}" class="product__zoom-wrapper"></div>
  {%- endif -%}

  <div class="card__section">
    {%- form 'product', product, id: product_form_id, class: 'product-form' -%}
      {%- for block in section.blocks -%}
        {%- case block.type -%}
          {%- when 'product_meta' -%}
            {%- render 'product-meta', product: product, block: block -%}

          {%- when 'variant_selector' -%}
            {%- render 'product-variant-selector', product: product, form: form, block: block -%}

          {%- when 'dimensions' -%}
            {%- assign dim_val = selected_variant.metafields.custom.dimention_specification.value | default: selected_variant.metafields.custom.dimention_specification | default: product.metafields.custom.dimention_specification.value | default: product.metafields.custom.dimention_specification -%}
            {%- assign mat_val = selected_variant.metafields.custom.material.value | default: selected_variant.metafields.custom.material | default: product.metafields.custom.material.value | default: product.metafields.custom.material -%}
            {%- if mat_val == blank -%}
              {%- assign mat_val = selected_variant.metafields.custom.materal.value | default: selected_variant.metafields.custom.materal | default: product.metafields.custom.materal.value | default: product.metafields.custom.materal -%}
            {%- endif -%}
            
            {%- assign dim_stripped = dim_val | strip_html | strip -%}
            {%- assign mat_stripped = mat_val | strip_html | strip -%}
            
            <div class="product-meta__dimensions-container {% if dim_stripped == blank and mat_stripped == blank %}is-hidden{% endif %}" {{ block.shopify_attributes }}>
              {%- if block.settings.display_mode == 'collapse' -%}
                <button class="product-meta__variant-description-button" data-action="toggle-collapsible" aria-expanded="false" aria-controls="dimensions-{{ section.id }}-{{ block.id }}">
                  <span class="product-meta__variant-description-title heading">{{ block.settings.title | escape }}</span>
                  <span class="plus-button"></span>
                </button>

                <div id="dimensions-{{ section.id }}-{{ block.id }}" class="card__collapsible">
                  <div class="card__collapsible-content">
                    <div class="product-specs-grid">
                      <div class="product-spec-item {% if dim_stripped == blank %}is-hidden{% endif %}" data-spec-type="dimension">
                        <span class="product-spec-label">Dimension</span>
                        <div class="product-spec-value product-meta__dimensions-content rte">{{ dim_val | newline_to_br }}</div>
                      </div>
                      
                      <div class="product-spec-item {% if mat_stripped == blank %}is-hidden{% endif %}" data-spec-type="material">
                        <span class="product-spec-label">Material</span>
                        <div class="product-spec-value product-meta__material-content rte">{{ mat_val | newline_to_br }}</div>
                      </div>
                    </div>
                  </div>
                </div>
              {%- else -%}
                <div class="product-specs-grid">
                  <div class="product-spec-item {% if dim_stripped == blank %}is-hidden{% endif %}" data-spec-type="dimension">
                    <span class="product-spec-label">Dimension</span>
                    <div class="product-spec-value product-meta__dimensions-content rte">{{ dim_val | newline_to_br }}</div>
                  </div>
                  
                  <div class="product-spec-item {% if mat_stripped == blank %}is-hidden{% endif %}" data-spec-type="material">
                    <span class="product-spec-label">Material</span>
                    <div class="product-spec-value product-meta__material-content rte">{{ mat_val | newline_to_br }}</div>
                  </div>
                </div>
              {%- endif -%}
            </div>

          {%- when 'variant_description' -%}
            {%- assign variant_desc = selected_variant.metafields.custom.variant_description.value | default: selected_variant.metafields.custom.variant_description -%}
            {%- assign variant_desc_stripped = variant_desc | strip_html | strip -%}
            
            <div class="product-meta__variant-description-container {% if variant_desc_stripped == blank %}is-hidden{% endif %}" {{ block.shopify_attributes }}>
              {%- if block.settings.display_mode == 'collapse' -%}
                <button class="product-meta__variant-description-button" data-action="toggle-collapsible" aria-expanded="false" aria-controls="variant-desc-{{ section.id }}-{{ block.id }}">
                  <span class="product-meta__variant-description-title heading">{{ block.settings.title | escape }}</span>
                  <span class="plus-button"></span>
                </button>

                <div id="variant-desc-{{ section.id }}-{{ block.id }}" class="card__collapsible">
                  <div class="card__collapsible-content">
                    <div class="product-meta__variant-description-content rte">
                      {{ variant_desc }}
                    </div>
                  </div>
                </div>
              {%- else -%}
                {%- if block.settings.title != blank -%}
                  <span class="product-meta__variant-description-title heading">{{ block.settings.title | escape }}</span>
                {%- endif -%}

                <div class="product-meta__variant-description-content rte">
                  {{ variant_desc }}
                </div>
              {%- endif -%}
            </div>

          {%- when 'buy_buttons' -%}
            {%- render 'product-buy-buttons', product: product, form: form, block: block -%}

          {%- when 'text' -%}
            {%- if block.settings.content != blank -%}
              <div class="product-meta__text rte" {{ block.shopify_attributes }}>
                {{- block.settings.content -}}
              </div>
            {%- endif -%}

          {%- when 'store_pickup' -%}
            {%- comment -%}The availability container will be added automatically if there is store pickup available{%- endcomment -%}
            <div class="product-meta__store-availability-container" {{ block.shopify_attributes }}>
              {%- render 'store-availability', product_variant: product.selected_or_first_available_variant -%}
            </div>

          {%- when 'featured_description' -%}
            {%- comment -%}This is only shown on the featured product section{%- endcomment -%}
            {%- if product.description != blank -%}
              <div class="product-meta__description rte" {{ block.shopify_attributes }}>
                {{ product.description | remove: 'data-section-type="product"' }}
              </div>
            {%- endif -%}

          {%- when '@app' -%}
            {%- render block -%}
        {%- endcase -%}
      {%- endfor -%}

      {%- assign product_meta_block = section.blocks | where: 'type', 'product_meta' | first -%}

      {%- if product_meta_block != blank and product_meta_block.settings.show_share_buttons -%}
        <div class="product-meta__share-buttons hidden-tablet-and-up">
          <span class="text--strong">{{ 'product.general.share' | t }}</span>

          {%- assign share_url = shop.url | append: product.url | url_param_escape -%}
          {%- assign twitter_text = product.title | url_param_escape -%}
          {%- assign pinterest_description = product.description | strip_html | truncatewords: 15 | url_param_escape -%}
          {%- assign pinterest_image = product.featured_media | img_url: '1024x' | prepend: 'https:' -%}

          <ul class="social-media__item-list list--unstyled" role="list">
            <li class="social-media__item social-media__item--facebook">
              <a href="https://www.facebook.com/sharer.php?u={{ share_url }}" target="_blank" rel="noopener" aria-label="{{ 'general.social.facebook_share' | t }}">{%- render 'icon', icon: 'facebook' -%}</a>
            </li>

            <li class="social-media__item social-media__item--pinterest">
              <a href="https://pinterest.com/pin/create/button/?url={{ share_url }}{% if pinterest_image != blank %}&media={{ pinterest_image }}{% endif %}&description={{ pinterest_description }}" target="_blank" rel="noopener" aria-label="{{ 'general.social.pinterest_pin' | t }}">{%- render 'icon', icon: 'pinterest' -%}</a>
            </li>

            <li class="social-media__item social-media__item--twitter">
              <a href="https://twitter.com/share?{% if twitter_text != blank %}text={{twitter_text}}&{% endif %}url={{ share_url }}" target="_blank" rel="noopener" aria-label="{{ 'general.social.twitter_tweet' | t }}">{%- render 'icon', icon: 'twitter' -%}</a>
            </li>

            <li class="social-media__item">
              <a href="mailto:?&subject={{ product.title | escape }}&body={{ share_url }}" aria-label="{{ 'general.social.email_share' | t }}">{% render 'icon', icon: 'email' %}</a>
            </li>
          </ul>
        </div>
      {%- endif -%}
    {%- endform -%}
  </div>

  {% comment %}
  ------------------------------------------------------------------------------
  Product Data. This must be outputted for all products (including home page).

  IMPORTANT: THIS CODE IS VITAL. DO NOT EDIT IT NOR REMOVE IT. MAKE SURE TO KEEP
  THE EXACT SAME ATTRIBUTES.
  ------------------------------------------------------------------------------
  {% endcomment %}

  {%- assign variant_selector_block = section.blocks | where: 'type', 'variant_selector' | first -%}

  <script type="application/json" data-product-json>
    {
      "product": {{ product | json }},
      "options_with_values": {{ product.options_with_values | json }},
      "selected_variant_id": {{ selected_variant.id }},
      "variant_descriptions": {
        {%- for variant in product.variants -%}
          "{{ variant.id }}": {{ variant.metafields.custom.variant_description.value | default: variant.metafields.custom.variant_description | json }}{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      },
      "variant_dimensions": {
        {%- for variant in product.variants -%}
          "{{ variant.id }}": {{ variant.metafields.custom.dimention_specification.value | default: variant.metafields.custom.dimention_specification | json }}{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      },
      "variant_materials": {
        {%- for variant in product.variants -%}
          {%- assign v_mat = variant.metafields.custom.material.value | default: variant.metafields.custom.material | default: variant.metafields.custom.materal.value | default: variant.metafields.custom.materal -%}
          "{{ variant.id }}": {{ v_mat | json }}{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      },
      "product_dimensions": {{ product.metafields.custom.dimention_specification.value | default: product.metafields.custom.dimention_specification | json }},
      "product_materials": {{ product.metafields.custom.material.value | default: product.metafields.custom.material | default: product.metafields.custom.materal.value | default: product.metafields.custom.materal | json }}
      {%- if variant_selector_block.settings.show_inventory_quantity -%}
        ,"inventories": {
          {%- for variant in product.variants -%}
            {%- if variant.available -%}
              {%- if variant.inventory_management and variant.inventory_policy == 'deny' and variant_selector_block.settings.low_inventory_threshold > 0 -%}
                {%- if variant.inventory_quantity <= variant_selector_block.settings.low_inventory_threshold -%}
                  {%- capture inventory_message -%}{{ 'product.form.low_stock_with_quantity_count' | t: count: variant.inventory_quantity }}{%- endcapture -%}
                {%- else -%}
                  {%- capture inventory_message -%}{{ 'product.form.in_stock_with_quantity_count' | t: count: variant.inventory_quantity }}{%- endcapture -%}
                {%- endif -%}
              {%- else -%}
                {%- if variant.inventory_policy == 'continue' and variant.inventory_quantity <= 0 and selected_variant.requires_shipping -%}
                  {%- if variant.incoming -%}
                    {%- capture next_incoming_date -%}{{ variant.next_incoming_date | date: format: 'date' }}{%- endcapture -%}
                    {%- capture inventory_message -%}{{ 'product.form.incoming_stock' | t: next_incoming_date: next_incoming_date }}{%- endcapture -%}
                  {%- else -%}
                    {%- capture inventory_message -%}{{ 'product.form.oversell_stock' | t }}{%- endcapture -%}
                  {%- endif -%}
                {%- else %}
                  {%- capture inventory_message -%}{{ 'product.form.in_stock' | t }}{%- endcapture -%}
                {%- endif -%}
              {%- endif -%}
            {%- else -%}
              {%- capture inventory_message -%}{{ 'product.form.sold_out' | t }}{%- endcapture -%}
            {%- endif -%}

            "{{ variant.id }}": {
              "inventory_management": {{ variant.inventory_management | json }},
              "inventory_policy": {{ variant.inventory_policy | json }},
              "inventory_quantity": {{ variant.inventory_quantity | json }},
              "inventory_message": {{ inventory_message | json }}
            }{% unless forloop.last %},{% endunless %}
          {%- endfor -%}
        }
      {%- endif -%}
    }
  </script>

  <script>
    document.addEventListener('variant:changed', function(event) {
      const variant = event.detail.variant;
      const descContainer = document.querySelector('.product-meta__variant-description-container');
      const descContents = document.querySelectorAll('.product-meta__variant-description-content');
      
      const dimContainer = document.querySelector('.product-meta__dimensions-container');
      const dimContents = document.querySelectorAll('.product-meta__dimensions-content');

      const productJson = document.querySelector('[data-product-json]');
      if (!productJson || !variant) return;
      
      const productData = JSON.parse(productJson.textContent);

      // Handle Description
      if (descContainer) {
        const descVal = productData.variant_descriptions ? productData.variant_descriptions[variant.id] : null;
        updateDynamicContent(descContainer, descContents, descVal);
      }

      // Handle Dimensions & Materials (2-column grid)
      const dimItems = document.querySelectorAll('.product-meta__dimensions-container');
      dimItems.forEach(container => {
        const dimVal = (productData.variant_dimensions && productData.variant_dimensions[variant.id]) ? productData.variant_dimensions[variant.id] : productData.product_dimensions;
        const matVal = (productData.variant_materials && productData.variant_materials[variant.id]) ? productData.variant_materials[variant.id] : productData.product_materials;

        const dimContents = container.querySelectorAll('.product-meta__dimensions-content');
        const matContents = container.querySelectorAll('.product-meta__material-content');
        
        const dimWrapper = container.querySelector('[data-spec-type="dimension"]');
        const matWrapper = container.querySelector('[data-spec-type="material"]');

        updateSyncField(dimWrapper, dimContents, dimVal);
        updateSyncField(matWrapper, matContents, matVal);

        if ((!dimVal || dimVal === "") && (!matVal || matVal === "")) {
          container.classList.add('is-hidden');
        } else {
          container.classList.remove('is-hidden');
        }
      });

      function updateSyncField(wrapper, contentAreas, value) {
        if (value && String(value).trim() !== "") {
          contentAreas.forEach(area => {
            area.innerHTML = String(value).replace(/\n/g, '<br>');
          });
          if(wrapper) wrapper.classList.remove('is-hidden');
        } else {
          if(wrapper) wrapper.classList.add('is-hidden');
        }
      }

      function updateDynamicContent(container, contentAreas, value) {
        if (value) {
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = value;
          const stripped = tempDiv.textContent.trim();
          
          if (stripped !== "") {
            contentAreas.forEach(area => {
              area.innerHTML = value.replace(/\n/g, '<br>');
            });
            container.classList.remove('is-hidden');
          } else {
            container.classList.add('is-hidden');
          }
        } else {
          container.classList.add('is-hidden');
        }
      }
    });
  </script>
</div>